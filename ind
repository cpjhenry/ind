#!/bin/bash
# Calculates Byzantine date & Indiction
# 2013-07-16/pjh

# See ChangeLog for changes.

[ $(uname) = 'Darwin' ] && [ ! $(which gdate) ] && echo "$(basename $0): 'coreutils' is required." && exit 1

GITREP=$HOME/src/ind
LDIAG=$GITREP/ldiagnostics

FULLCE=
PARTCE=
COMMON=true

DDATE=
HHPC=
HEBREW=

MASORETIC=
ROME=
BYZANTINE=

JULIANPRD=
ARC=

JAPANIY=
CHINALY=
BUDDHIST=

hol=true

masconvert=4000	# Masoretic Text; 4000 BCE
romconvert=752  # Founding of Rome, January 1st (Julian calendar); 753 BCE
byzconvert=5508 # Byzantine year, September 1st (Julian calendar); 5509 BCE

jupconvert=4713	# Julian Period; 4713 BCE
arcconvert=1352 # A.R.C., March 21th, 1:06 a.m. ET; 1353 BCE

jiyconvert=660	# Japanese Imperial year; 660 BCE
chiconvert=2697	# Chinese Lunar year, 21 January to 20 February; 2698 BCE
rocconvert=1911 # ROC year; 1912 CE

budconvert=543	# Buddhist Era or Thai Solar year; 543 BCE

ZODIAC=(Rat Ox Tiger Rabbit Dragon Snake Horse Goat Monkey Rooster Dog Pig)
CNYDATE=(02-05 01-25 02-12 02-01 01-22 02-10 01-29 02-17 02-06 01-26 02-13 02-03 01-23 02-11 01-31 02-19 02-08 01-28 02-15 02-04)

EPACTS=(0 29 10 21 2 13 24 5 16 27 8 19 30 11 22 3 14 25 6 17)
DOMINI=(G A B C D E F)
PHASES=("New Moon" "First Quarter" "Full Moon" "Last Quarter")

MONTHS=(- Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec)
MONTHL=(- January February March April May June July August September October November December)
DOWS=(Sun Mon Tue Wed Thu Fri Sat)
DOWL=(Sunday Monday Tuesday Wednesday Thursday Friday Saturday)

setdate() { # usage: setdate [yesterday|today|tomorrow]
	year=$(date -d "$1" +%Y)
	month=$(date -d "$1" +%0m)
	day=$(date -d "$1" +%0d)
}
ordinal() {
	case "$1" in
		1)	ord="st";;
		2)	ord="nd";;	
		3)	ord="rd";;
		21)	ord="st";;
		22)	ord="nd";;
		23)	ord="rd";;
		31)	ord="st";;
		*)	ord="th";;
	esac
}
is_leap_year() { ## USAGE: is_leap_year [year]
	ily_year=${1:-$(date +%Y)}
	case $ily_year in
		*0[48] | *[2468][048] | *[13579][26] | *[02468][048]00 | *[13579][26]00 ) _LEAP_YEAR=1
		return 0 ;;
		*) unset _LEAP_YEAR
		return 1 ;;
	esac
}
NWR() { # Not within range
	echo "$(basename $0): Y-M-D not within range."
	exit 1
}
advent() {
	local xmasdow
	local xmasadj
	xmasdow=$(date -d "$1-12-25" +%w)
	xmaswks=3
	[ $xmasdow -eq 0 ] && (( xmaswks+=1 ))
	(( xmasadj=(xmaswks * 7) + xmasdow ))
	date -d "$1-12-25 - $xmasadj days" +%F
}
displayall() {
	COMMON=true;
	HHPC=true; DDATE=true; HEBREW=true; 
	MASORETIC=true; ROME=true; BYZANTINE=true;
	JULIANPRD=true; ARC=true;
	JAPANIY=true; CHINALY=true; BUDDHIST=true;
}
displaynone() {
	unset FULLCE; unset PARTCE; unset COMMON;
	unset HHPC; unset DDATE; unset HEBREW;
	unset MASORETIC; unset ROME; unset BYZANTINE;
	unset JULIANPRD; unset ARC;
	unset JAPANIY; unset CHINALY; unset BUDDHIST; 

	unset LUNAR; unset CHINESE; unset VERBOSE;
}

setdate today # set today's date

while getopts ":anfcpejMrzuxAiqby:m:d:hHvlCDU?" OPTION
do
	case $OPTION in
		a) 	displayall;;													# display all
		n)	displaynone;;													# display none
		f)	[ $FULLCE ]		&& unset FULLCE		|| FULLCE=true;;			# date
		c)	[ $COMMON ] 	&& unset COMMON 	|| COMMON=true;;			# common year

		p)	[ $HHPC ]		&& unset HHPC		|| HHPC=true;;				# Hanke-Henry
		e)	[ $DDATE ]		&& unset DDATE		|| DDATE=true;;				# Erisian
		j)	[ $HEBREW ] 	&& unset HEBREW 	|| HEBREW=true;;			# Hebrew

		M)	[ $MASORETIC ]	&& unset MASORETIC	|| MASORETIC=true;;			# Masoretic
		r)	[ $ROME ] 		&& unset ROME 		|| ROME=true;;				# Roman
		z)	[ $BYZANTINE ] 	&& unset BYZANTINE 	|| BYZANTINE=true;;			# Byzantine

		u)	[ $JULIANPRD ]	&& unset JULIANPRD	|| JULIANPRD=true;;			# Julian period
		x)	[ $ARC ]		&& unset ARC		|| ARC=true;;				# A.R.C.
		A)	printf "%s* Advent\n" "$(date -d $(advent $year) "+%e %b")"		# Advent
			exit;;

		i)	[ $JAPANIY ] 	&& unset JAPANIY	|| JAPANIY=true;;			# Japanese Imperial
		q)	[ $CHINALY ]	&& unset CHINALY	|| CHINALY=true;;			# Chinese Lunar
		b)	[ $BUDDHIST ] 	&& unset BUDDHIST 	|| BUDDHIST=true;;			# Buddhist

		y)	year=$OPTARG;;													# set year
		m)	month=$OPTARG;;													# set month
		d)	day=$OPTARG														# set day
			[ "$(egrep [[:alpha:][:blank:]-] <<< $day)" ] && setdate "$day";;

		h)	unset hol;;														# disable holidays
		H)	bold="**" ; italics="_";;										# highlight
 		v)	[ $VERBOSE ]	&& unset VERBOSE	|| VERBOSE=true;;			# verbose

		l)	[ $LUNAR ]		&& unset LUNAR		|| displaynone;LUNAR=true;;	# lunar diagnostic data
		C)	[ $CHINESE ]	&& unset CHINESE	|| CHINESE=true;;			#- Chinese NY diagnostics

		D)	while IFS= read -r line; do										# check dependencies
				[ $(which $line) ] || echo "Install '$line'"; done \
			< <(grep "DEP" $0 | sed -e "/grep DEP/d;s/^.*DEP[: ]*//")
			exit;;
		U)	cp -uv $HOME/bin/ind $GITREP/									#- update git repository
			cp -uv $HOME/bin/getusage $GITREP/
			cp -uv $HOME/bin/rnum $GITREP/
			cp -uv $HOME/share/man/man1/ind.1 $GITREP/
			cp -uv $HOME/share/man/man7/uposatha.7 $GITREP/
			exit;;
		*)	[ $(which getusage) ] && getusage $0;exit;;
	esac
done

# Initialize
is_leap_year $year
[ $year -le 0 ] && NWR
[ $month -lt 1 -o $month -gt 12 ] && NWR
[ $day -lt 1 -o $day -gt 31 ] && NWR
[ $day -gt 30 ] && [ $month -eq 9 -o $month -eq 4 -o $month -eq 6 -o $month -eq 11 ] && NWR
[   $_LEAP_YEAR ] && [ $month -eq 2 -a $day -gt 29 ] && NWR
[ ! $_LEAP_YEAR ] && [ $month -eq 2 -a $day -gt 28 ] && NWR

month=$(printf "%02d" $((10#$month)))
day=$(printf "%02d" $((10#$day)))
ymd=$year-$month-$day
hms=$(date +%T)
dow=$(date -d $ymd +%w)

doy=$(date -d $ymd +%-j) 	# day of year
iwn=$(date -d $ymd +%-V) 	# ISO week no
tz=$(date -d $ymd +%Z)		# time zone
utc=$(date -ud "$ymd $hms $tz" "+%F %T")

# Julian calendar has 13 day delta for 20th/21st centuries
jymd=$(date -d "$ymd - 13 days" +%F)
jdoy=$(date -d "$jymd" +%-j)
[ $month -eq 1 -a $day -le 13 ] && jdoy=0

# Set Modified Julian Date, Truncated Julian Date & Rata Die (UTC); DEP jday
if [ $(which jday) ] ; then
	mjd=$(echo "$(jday -d $utc)-2400000.5" | bc )
	tjd=$(echo "$(jday -d $utc)-2440000.5" | bc | cut -f1 -d"." )
	rdi=$(echo "$(jday -d $utc)-1721424.5" | bc | cut -f1 -d"." )
else 
	unset mjd
	unset tjd
	unset rdi
fi

# Set Roman numeral year; DEP rnum
if [ $(which rnum) ]; then
	rnyear=$(rnum $year)
else rnyear="/"; fi

# Set Hanke-Henry date; DEP hh
if [ $(which hh) ] && [ $year -ge 2018 ]; then
	hhdate=$(hh -W -d$day -m$month -y$year)
else unset HHPC; fi

# Set Discordian date; DEP ddate
if [ $(which ddate) ]; then
	discord=$(ddate +'%{%e %B%} %Y' $day $month $year | sed 's/The //')
	dischol=$(ddate +'%N%H' $day $month $year)
else unset DDATE; fi

# Hebrew calendar; DEP hebcal
if [ $(which hebcal) ]; then
	hebdate=$(hebcal -h $month $day $year | sed "s/$ymd //")
else unset HEBREW; fi

# Lunar and Lunisolar Calculations
(( golden=year%19+1 ))
(( dominical=((year-1)%100%4*2+(year-1)%100%7*4+(year-1)/100%4*2)%7 ))

if [ $_LEAP_YEAR ]; then
	if [ $dominical -eq 0 ]; then dom="${DOMINI[$dominical]}${DOMINI[6]}"
	else dom="${DOMINI[$dominical]}${DOMINI[$dominical-1]}"; fi
else dom="${DOMINI[$dominical]}"; fi

# Moons; DEP phases
if [ $(which phases) ]; then
	for i in {1..12}; do
		while IFS= read -r line; do
		    newmoon+=( "$(date -d "$line UTC" +%F)" )
		    chinesemoon+=( "$(TZ=Asia/Shanghai date -d "$line UTC" +%F)" )
		done < <( phases $year $i 0 )

		while IFS= read -r line; do
		    fullmoon+=( "$(date -d "$line UTC" +%F)" )
		done < <( phases $year $i 1 )
	done
	for i in "${newmoon[@]}"; do
		[ "${i:5:2}" = "$month" ] && [ $MOONSET ] && bkmoon=$i
		[ "${i:5:2}" = "$month" ] && [ ! $MOONSET ] && moonphase[0]=$i && MOONSET=true
		[ "$i" = "$ymd" ] && moon=${PHASES[0]}
		[ "$bkmoon" = "$ymd" ] && moon="Black Moon"
	done
	unset MOONSET
	for i in "${fullmoon[@]}"; do
		[ "${i:5:2}" = "$month" ] && [ $MOONSET ] && blmoon=$i
		[ "${i:5:2}" = "$month" ] && [ ! $MOONSET ] && moonphase[2]=$i && MOONSET=true
		[ "$i" = "$ymd" ] && moon=${PHASES[2]} && FULL=true
		[ "$blmoon" = "$ymd" ] && moon="Blue Moon" && unset FULL
	done
	[ ! $MOONSET ] && MOONSET=true # February is shorter than a standard lunation
	[ $FULL ] && [ $month -eq 9 ] && moon="Harvest Moon"

	# Vassa
	vsday=$(date -d "$(phases $year 7 1 | sed -n 1p) + 1 day" +%d)

	# Chinese calendar
	cstep=1; for i in "${chinesemoon[@]}"; do
		if [ $cstep -eq 1 ]; then
			[ "${i:5:2}" == "01" -a "${i:8:2}" -ge 21 ] && lunarmonth[$cstep]=$i && ((cstep++))
			[ "${i:5:2}" == "02" ] && lunarmonth[$cstep]=$i && ((cstep++))
		else
			lunarmonth[$cstep]=$i
			((cstep++))
		fi
	done
	[ $year -eq 2027 ] && lunarmonth[1]=$(date -d "${lunarmonth[1]} - 1 day" +%F)

	# Chinese Lunar Year
	cny=${lunarmonth[1]}	
	(( cly=year+chiconvert ))
	[[ 10#$doy -ge 10#$(date -d "$cny" +%j) ]] && (( cly+=1 ))
	(( roc=year-rocconvert ))

	# Chinese festivals

	# A leap month is inserted if there are 13 New Moons from the start of the 11th
	# month in the first year to the start of the 11th month in the following year.

	lm=0; thnm=(2020 2023 2025 2028)
	for i in "${thnm[@]}"; do
		[ $year -eq $i ] && lm=1
	done

	qingming="$year-04-05"
	midautumn=$(date -d "${lunarmonth[8+$lm]} + 14 days" +%F)

	# 'year of'
	case 1 in
		$(($year< 2020))) (( yearof=$year-2008 )) ;;
		$(($year< 2032))) (( yearof=$year-2020 )) ;;
		$(($year< 2044))) (( yearof=$year-2032 )) ;;
	esac

	# Diagnostics
	[ $CHINESE ] && printf "%s %s %s\n" $year ${cny:5:5} ${CNYDATE[(($year-2019))]} && exit
	[ $LUNAR ] && [ -f $LDIAG ] && . $LDIAG && exit
else
	unset MOONSET
	unset CHINALY
fi

# Simple year calculations
(( masor=year+masconvert ))
(( julp=year+jupconvert ))
(( jiy=year+jiyconvert ))
(( buddhist=year+budconvert ))

# Roman & Byzantine calendars are aligned to Julian calendar
(( rome=year+romconvert ))
[[ 10#$jdoy -ge 1 ]] && (( rome+=1 )) # January 1st

(( byzantine=year+byzconvert ))
[[ 10#$jdoy -ge 10#$(date -d "1 Sept $year" +%j) ]] && (( byzantine+=1 ))

# ARC
(( arc=year+arcconvert ))
[[ 10#$doy -ge 10#$(date -d "21 March $year" +%j) ]] && (( arc+=1 ))

# Beware the Ides...
[ $month -eq 3 -o $month -eq 5 -o $month -eq 7 -o $month -eq 10 ] && ides=15 || ides=13

# Indictions and ordinals
(( ind=($year+2)%15+1 ))	# set Gregorian indiction
ordinal $ind; gord=$ord 	# set Gregorian ordinal

(( byzind=$byzantine%15 ))	# set Byzantine indiction
[ $byzind -eq "0" ] && byzind=15
ordinal $byzind; bord=$ord	# set Byzantine ordinal

ordinal $(( 10#$day )) 		# set standard ordinal

# main()
[ $FULLCE ]		&& printf "$bold%s %d %s %d$bold\n" ${DOWL[$dow]} $(( 10#$day )) ${MONTHL[10#$month]} $year
[ $PARTCE ]		&& printf "$bold%s %d%s %s$bold\n" ${DOWL[$dow]} $(( 10#$day )) $ord ${MONTHL[10#$month]}

if [ $COMMON ]; then
				printf "$bold"; printf "CE %d %s %2d%s Ind." $year $rnyear $ind $gord; echo "$bold"
				printf "Day %3d / Week %2d %3s\n" $doy $iwn $tz
	[ $mjd ] && printf "MJD %s %s UTC\n" ${mjd:0:7} "${utc:5:5}" | sed 's/-/\//'
	[ $tjd ] && printf "TJD %5s " $tjd
	[ $rdi ] && printf "/ RD %s\n" $rdi; [ $tjd ] && [ ! $rdi ] && printf "\n"
fi

[ $HHPC ]		&& printf "%-17s H-H %4d\n" "${hhdate::${#hhdate}-5}" ${hhdate:(-4)}
[ $DDATE ]		&& printf "%-16s YOLD %d\n" "${discord::${#discord}-5}" ${discord:(-4)}
[ $HEBREW ]		&& printf "%-18s AM %d\n" "${hebdate::${#hebdate}-6}" ${hebdate:(-4)}

[ $MASORETIC ]	&& printf "Masoretic          AL %d\n" $masor
[ $ROME ]		&& printf "City of Rome       au %d\n" $rome
[ $BYZANTINE ]	&& printf "Byzantine (%2d%s)   AM %d\n" $byzind $bord $byzantine

[ $JULIANPRD ]	&& printf "Julian Period         %d\n" $julp
[ $ARC ]		&& printf "A.R.C.                %d\n" $arc

[ $JAPANIY ]	&& printf "Japanese Imperial     %d\n" $jiy
[ $CHINALY ]	&& printf "Chinese Lunar (%3d)   %d\n" $roc $cly
[ $BUDDHIST ]	&& printf "Buddhist Era          %d\n" $buddhist

if [ $VERBOSE ]; then
	[ $cny ] 		&& printf "Chinese New Year      %s\n" ${cny:5:5} | sed 's/-/\//'
	[ $_LEAP_YEAR ] && printf "Leap year             %s\n" $year
	[ "$moon" ]		&& printf "Moon                  %s\n" "$moon" | sed 's/ Moon//'

	printf "Julian calendar       %s\n" ${jymd:5:5} | sed 's/-/\//'
	printf "Julian day of year    %03d\n" $jdoy
	printf "Dominical letter      %s\n" $dom
	printf "Epact                 %s\n" ${EPACTS[$golden]}
	printf "Golden number         %s\n" $golden
	printf "Ides                  %d\n" $ides
fi

# Lunar observances and holidays
if [ $hol ]; then
	if [ $COMMON ]; then	
		[ "$ymd" = "$(advent $year)" ] && dhol+=$(echo "Advent|")
	fi
	if [ $CHINALY ]; then
		[ "$ymd" = "$cny" 		] && dhol+=$(echo "Spring Festival (Year of the ${ZODIAC[10#$yearof]})|")
		[ "$ymd" = "$qingming"	] && dhol+=$(echo "Tomb Sweeping Festival|")
		[ "$ymd" = "$midautumn"	] && dhol+=$(echo "Mid-Autumn Moon Festival|")
	fi
	if [ $BUDDHIST ]; then
		[ "$moon" ] && observe=$(echo "$moon Uposatha|")

		# only the first full moon
		if [ $FULL ] ; then
			[ $month -eq 2  ] && observe=$(echo "Sangha day|")
			[ $month -eq 5  ] && observe=$(echo "Buddha day|")
			[ $month -eq 7  ] && observe=$(echo "Dhamma day|")
			[ $month -eq 10 ] && observe=$(echo "Pavarana|")
		fi
		[ "$observe" ] && dhol+=$observe
		[ $vsday ] && [ $month -eq 7 -a $day -eq $vsday ] && dhol+=$(echo "Vassa|")
	fi

	# Fixed non-lunar holidays
	[ $DDATE ] && [ "$dischol" ] && dhol+=$(echo "$bold$dischol$bold|")
	[ $ARC ] && [ $month -eq 3 -a $day -eq 21 ] && dhol+=$(echo "R+C New Year Feast|")
	[ $ARC ] && [ $month -eq 9 -a $day -eq 23 ] && dhol+=$(echo "R+C Outdoor Fete|")

	if [ $COMMON ]; then
		[ $day -eq $ides ] && dhol+=$(echo "Ides of ${MONTHL[10#$month]}|")
		[ $month -eq 5 -a $day -eq 25 ]  && dhol+=$(echo "Towel Day|")
		[ $month -eq 7 -a $day -eq 5 ]	 && dhol+=$(echo "X-Day|")

		# Quarter Days
		[ $month -eq 3 -a $day -eq 25 ]	 && dhol+=$(echo "Lady Day|")
		[ $month -eq 6 -a $day -eq 24 ]  && dhol+=$(echo "Midsummer Day|")
		[ $month -eq 9 -a $day -eq 29 ]	 && dhol+=$(echo "Michaelmas|")
		[ $month -eq 12 -a $day -eq 25 ] && dhol+=$(echo "Quarter Day|")

		# Cross Quarter Days
		[ $month -eq 2 -a $day -eq 2 ]   && dhol+=$(echo "Candlemas|")
		[ $month -eq 5 -a $day -eq 1 ]   && dhol+=$(echo "May Day|")
		[ $month -eq 8 -a $day -eq 1 ]	 && dhol+=$(echo "Lammas|")
		[ $month -eq 11 -a $day -eq 1 ]	 && dhol+=$(echo "All Saints' Day|")

		# Scottish Term Days
		[ $month -eq 5 -a $day -eq 15 ]  && dhol+=$(echo "Whitsun|")
		[ $month -eq 11 -a $day -eq 11 ] && dhol+=$(echo "Martinmas|")
	fi

	# Display results
	[ "$dhol" ] && echo "- - -" && echo -en "$dhol" | sed 's/|/\n/g' | sed "s/^/$italics/;s/$/$italics/"
fi
