#!/bin/bash
# Movable observances, Hebrew calendar & yahrtzeits
# 2019-10-23

app=$(basename $0)
[ $(uname) = 'Darwin' ] && [ ! $(which gdate) ] && echo "$app: 'coreutils' is required." && exit 1
for i in calendar hebcal; do [ ! $(which $i) ] && echo "$app: '$i' is required." && exit 1; done
cond_source() { [ -f $1 ] && . $1; }

year=$(date +%Y)
DATEFMT="%d %b"
YAHRFILE="$HOME/.calendar/deaths"
HEADER=true
HEBREW=true
PROXIM=true

while getopts ":cejlYPAy:?" OPTION; do
	case $OPTION in
		c)	# Format for 'calendar'
			DATEFMT="%m/%d"
			CFORMAT=true
			[ $HEADER ] && echo "// Generated by '$(basename $0)'";;
		e)	# Erevs
			EREV=true;;
		j)	# Hebrew holidays
			[ $HEBREW ] && unset HEBREW || HEBREW=true;;
		l)	# Holiday information
			printf "Movable observances:\n\n"
			printf "Purim              Feast, defeat of an extermination plot\n"
			printf "Pesach (Passover)  Pilgrimage, the Exodus from Egypt\n"
			printf "Shavuot            Pilgrimage, the giving of the Torah\n"
			printf "Tish'a B'Av        Day of Mourning, destruction of the Temples\n"
			printf "Rosh Hashana       New Year for years\n"
			printf "Yom Kippur         Day of Atonement, fasting\n"
			printf "Sukkot             Pilgrimage, the wandering in the desert\n"
			printf "Chanukah           Festival of Lights, rededication of the Temple\n\n"
			printf "Yahrzeit           Anniversary of the death of a parent or close relative\n"
			printf "Advent             Period of preparation for the celebration of Christmas\n"
			exit;;		
		Y)	# Yahrzeits
			YAHR=true;;
		P)	# Proximate dates
			[ $PROXIM ] && unset PROXIM || PROXIM=true;;
		A)	# Advent
			[ $ADVENT ] && unset ADVENT || ADVENT=true;;

		y)	# set year
			year=$OPTARG;;

		*)	getusage $0
			exit;;
	esac
done
hebyear=$(hebcal -Th 01 01 $year | sed -n 1p | sed 's/.*, //')

function set_hebrew() {
	exclude="/Shabbat/d;/Ta'anit/d"
	hebdate=$(date -d $(hebcal -rx $1 $2|sed "1d;$exclude" |cut -f1) +"$DATEFMT")
	hebtext=$(hebcal -rx $1 $2 |cut -f2 |sed "1d;$exclude;s/ I//;/1 Candle/s/^/Erev /;s/:.*//")
	dispheb+=$(printf "%s*\t%s|" "$hebdate" "$hebtext")
}

# Hebrew holidays
for i in "Adar 14" "Nissan 15" "Sivan 6"; do set_hebrew "$i" $hebyear; done

tishabav=$(hebcal -rh Av 9 $hebyear | cut -f1)
[[ $(date -d "$tishabav" +%w) == 6 ]] && # !Shabbat
	set_hebrew "$(date -d "$tishabav + 1 day" +"%m %d %Y")" ||
	set_hebrew "$(date -d "$tishabav" +"%m %d %Y")"

(( hebyear+=1 ))
for i in "Tishrey 1" "Tishrey 10" "Tishrey 15" "Kislev 25"; do set_hebrew "$i" $hebyear; done

if [ $EREV ]; then
	for i in $(hebcal -rx $year |grep Erev |cut -f1); do set_hebrew "$(date -d "$i" +"%m %d %Y")"; done
	set_hebrew "$(date -d $(hebcal -rx $year |grep "1 Candle" |cut -f1) +"%m %d %Y")"
fi

# display results
if [ $HEBREW ]; then outp=true
	echo -en "$dispheb" |sed 's/|/\n/g' |sort -Mk2
fi

if [ $YAHR ]; then [ $outp ] && echo ; outp=true
	[ -e $YAHRFILE ] &&
		hebcal -hY $YAHRFILE $year |sed -e 's/^....-..-..\s/$(date -d& +"$DATEFMT")*/' |
		while read -r line; do eval echo -e "$line" |sed 's/\*/*\tâ˜  /'; done
fi

# Dates calculated by their proximity to another date
if [ $PROXIM ]; then [ $outp ] && echo; outp=true
	# Black Friday (&c.)
	hold="Nov $(ncal -hm 11 |awk '/^Th/{print $5}')"
	printf "%s*\tBlack Friday\n"	"$(date -d "$hold +1 day"  +"$DATEFMT")"
	printf "%s*\tCyber Monday\n"	"$(date -d "$hold +4 days" +"$DATEFMT")"
	printf "%s*\tGiving Tuesday\n" 	"$(date -d "$hold +5 days" +"$DATEFMT")"
fi
if [ $ADVENT ]; then [ $outp ] && echo
	xmasdow=$(date -d "$year-12-25" +%w)
	xmaswks=3; [ $xmasdow -eq 0 ] && (( xmaswks+=1 ))
	advent="$(date -d"$year-12-25 -$(((xmaswks*7)+xmasdow)) days" +"$DATEFMT")"
	dpr="$(date -d"$advent $year -11 days" +"$DATEFMT")"

	printf "%s*\tDay of Prayer & Repentance\n" "$dpr"
 	printf "%s*\tAdvent\n" "$advent"
fi
